<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>1&nbsp;Esterel in Racket, for Racket Programmers</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="../racket.css" title="default"/><link rel="stylesheet" type="text/css" href="footnote.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../doc-site.css" title="default"/><script type="text/javascript" src="../scribble-common.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../doc-site.js"></script><script type="text/javascript" src="file:///Applications/Racket%20v8.11.1/doc/local-redirect/local-redirect.js"></script><script type="text/javascript" src="file:///Users/elliberes/Library/Racket/8.11.1/doc/local-redirect/local-user-redirect.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Esterel in Racket</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Esterel in Racket, for Racket Programmers</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="sec_eir-esterel.html" class="tocviewlink" data-pltdoc="x">Esterel in Racket, for Esterel Programmers</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="kernel.html" class="tocviewlink" data-pltdoc="x">Kernel Esterel Reference</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="reference.html" class="tocviewlink" data-pltdoc="x">Esterel Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-bibliography.html" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Esterel in Racket, for Racket Programmers</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">1.1&nbsp;</td><td><a href="#%28part._.A_.Traffic_.Light%29" class="tocviewlink" data-pltdoc="x">A Traffic Light</a></td></tr><tr><td align="right">1.2&nbsp;</td><td><a href="#%28part._.Causality%29" class="tocviewlink" data-pltdoc="x">Causality</a></td></tr><tr><td align="right">1.3&nbsp;</td><td><a href="#%28part._sec~3aconts%29" class="tocviewlink" data-pltdoc="x">Using Continuations to Replay
Reactions and How Mutation Causes Trouble</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#%28part._.A_.Traffic_.Light%29" class="tocsubseclink" data-pltdoc="x">A Traffic Light</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#%28part._.Causality%29" class="tocsubseclink" data-pltdoc="x">Causality</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#%28part._sec~3aconts%29" class="tocsubseclink" data-pltdoc="x">Using Continuations to Replay
Reactions and How Mutation Causes Trouble</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.11.1&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.11.1&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;Esterel in Racket&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Esterel in Racket&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="sec_eir-esterel.html" title="forward to &quot;2 Esterel in Racket, for Esterel Programmers&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div><h3 x-source-module="(lib &quot;esterel/esterel.scrbl&quot;)" x-source-pkg="esterel-doc" x-part-tag="&quot;Esterel_in_Racket__for_Racket_Programmers&quot;">1<tt>&nbsp;</tt><a name="(part._.Esterel_in_.Racket__for_.Racket_.Programmers)"></a>Esterel in Racket, for Racket Programmers</h3><p><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If you are familiar with Esterel but not
Racket, start by reading <a href="sec_eir-esterel.html" data-pltdoc="x">Esterel in Racket, for Esterel Programmers</a> instead
of this section.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara">Esterel is a synchronous reactive programming language that
dates to 1983. It has imperative features combined with
parallelism and the ability to abort already-running
computation, but Esterel is deterministic, with every
program guaranteed to produce its particular result no
matter how the various threads run or which threads are
aborted.</div></p><p>One way to think of imperative computation is as if the
program goes through a series of different states, where
each step in the computation updates a bunch of variables,
causing the program to be in a new state. In this sense, the
computation proceeds through a series of different states as
it executes and the programmer, to be able to understand and
modify the program, must think about these state changes
when imagining the program&rsquo;s behavior. In this sense,
Esterel is an imperative programming language but, unlike
more conventional imperative programming languages,
Esterel&rsquo;s state changes are more restricted, giving the
programmer more guarantees about the behavior of the
program.</p><p>In Esterel, to restrict the state changes, the program is
broken up in a series of <a name="(tech._instant)"></a><span style="font-style: italic">instants</span> (also called
<a name="(tech._reaction)"></a><span style="font-style: italic">reactions</span>). Within each instant, the entire
program always sees a coherent, single state. That is,
within an instant there are no state changes; instead each
instant computes a new state and the entire Esterel program
sees only that new state. Furthermore, each instant is
captured via a construct in the programming language,
<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._pause%29%29" class="RktValLink" data-pltdoc="x">pause</a></span>. That is, each thread must, after some finite
amount of time, invoke <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._pause%29%29" class="RktValLink" data-pltdoc="x">pause</a></span> (or terminate or be
aborted) and the time between these pauses always has a
single consistent state, visible to the entire computation.</p><p>Of course, Esterel&rsquo;s enforcement of determinacy during each
<a href="#%28tech._instant%29" class="techoutside" data-pltdoc="x"><span class="techinside">instant</span></a> applies only to Esterel programs and Esterel
threads; Racket&rsquo;s threads are not required to explicitly
pause and remain as complex and difficult to reason about as
ever.</p><p>Separating Esterel computation from normal imperative Racket
computation, however, is simply a matter of wrapping
<span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span> around some expressions. Any code that runs
in the dynamic extent of those expressions is treated as
Esterel code. Unfortunately, ordinary Racket mutable
variables do not automatically become Esterel-like; instead,
the Esterel code must use <a href="#%28tech._signal%29" class="techoutside" data-pltdoc="x"><span class="techinside">signal</span></a>s for any values that
change over time. Unfortunately, Esterel computations do not
check or guarantee that Racket code run during an instant is
otherwise pure, and surprising behavior may result if Racket
code uses mutation while it is running in an Esterel
context. We return to this point in <a href="#%28part._sec~3aconts%29" data-pltdoc="x">Using Continuations to Replay
Reactions and How Mutation Causes Trouble</a>;
for now, simply imagine only pure Racket code running
alongside Esterel.</p><h4 x-source-module="(lib &quot;esterel/esterel.scrbl&quot;)" x-source-pkg="esterel-doc" x-part-tag="&quot;A_Traffic_Light&quot;">1.1<tt>&nbsp;</tt><a name="(part._.A_.Traffic_.Light)"></a>A Traffic Light</h4><p>To make this abstract notation of state change and pauses
and instants more concrete, let&rsquo;s look at some code that
controls a traffic signal with three lights: red, orange,
and green. Red means that cars should stop; orange means
that red is coming soon, so either slow in preparation to
stop or finish transiting the intersection; green means
that it is safe to transit the intersection.</p><p>To control the lights we will use three signals. A
<a name="(tech._signal)"></a><span style="font-style: italic">signal</span> in Esterel has two states: either it is
present or it is absent. Signals can also carry values, but
to control our traffic light, we&rsquo;ll just use presence to
indicate that the light should be on and absence to indicate
that it should be off. Here&rsquo;s how we declare the signals:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._define-signal%29%29" class="RktStxLink" data-pltdoc="x">define-signal</a></span><span class="hspace">&nbsp;</span><span class="RktSym">red</span><span class="hspace">&nbsp;</span><span class="RktSym">orange</span><span class="hspace">&nbsp;</span><span class="RktSym">green</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This introduces three new Racket identifiers, <span class="RktSym">red</span>,
<span class="RktSym">orange</span>, and <span class="RktSym">green</span>, each bound to a signal.</p><p>To run an Esterel program, we need to wrap the code in
<span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span>. Any code or helper functions can be
invoked from inside. That is, Esterel
code runs in the dynamic extent of <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span>. For
starters, let&rsquo;s just make a traffic signal that is
permanently red. Here&rsquo;s the code to do that:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">forever-red</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=let.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._let%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._loop%29%29" class="RktStxLink" data-pltdoc="x">loop</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">red</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._pause%29%29" class="RktValLink" data-pltdoc="x">pause</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._loop%29%29" class="RktStxLink" data-pltdoc="x">loop</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote><p>Looking at the code line by line, we see <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span>,
which wraps our Esterel program, then a recursive loop
definition, followed by <span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="stt"> </span><span class="RktSym">red</span><span class="RktPn">)</span> which causes
the signal <span class="RktSym">red</span> to be emitted and thus present.
Then <span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._pause%29%29" class="RktValLink" data-pltdoc="x">pause</a></span><span class="RktPn">)</span>, indicating that the instant is
over. Once the next instant starts, it will pick up right at
the <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._pause%29%29" class="RktValLink" data-pltdoc="x">pause</a></span>, and go back around the loop, emitting
the red signal again and pausing.</p><p>This code does not actually run yet, however. To run the
code, we need to use <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span>. Each time we invoke
<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span>, a single <a href="#%28tech._instant%29" class="techoutside" data-pltdoc="x"><span class="techinside">instant</span></a> runs and
<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span> returns the signals that were emitted,
always <span class="RktSym">red</span>.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">forever-red</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: red&gt; . #t))</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">forever-red</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: red&gt; . #t))</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">forever-red</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: red&gt; . #t))</span></p></td></tr></table></blockquote><p>In Esterel, repeatedly emitting a specific signal and
pausing is a common pattern and is captured via the function
<span class="RktSym"><a href="reference.html#%28def._%28%28lib._esterel%2Ffull..rkt%29._sustain%29%29" class="RktValLink" data-pltdoc="x">sustain</a></span>. Accordingly, this is the same program, but
written more compactly:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">forever-red</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28def._%28%28lib._esterel%2Ffull..rkt%29._sustain%29%29" class="RktValLink" data-pltdoc="x">sustain</a></span><span class="hspace">&nbsp;</span><span class="RktSym">red</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote><p>Of course, we would like our traffic signal to change color
so cars can pass through the intersection. Let&rsquo;s say that
our green should last two minutes, and then orange for four
seconds, and then we&rsquo;ll change to red. To set this up, we&rsquo;ll
introduce a signal that is emitted every second:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._define-signal%29%29" class="RktStxLink" data-pltdoc="x">define-signal</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span></td></tr></table></blockquote><p>And now we turn to the loop that emits
<span class="RktSym">forever-red</span>. A Rackety approach to this problem
might be to change the loop so that it has a parameter and
it counts the number of instants that passed where
<span class="RktSym">second</span> is emitted, and based on that, emit the
correct signal.</p><p>Instead, and because aborting is completely safe and
reliable in Esterel, we can separate the code that is
emitting the signal from the code that decides how long to
wait, letting those the two tasks be handled in parallel,
like this:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._abort%29%29" class="RktStxLink" data-pltdoc="x">abort</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28def._%28%28lib._esterel%2Ffull..rkt%29._sustain%29%29" class="RktValLink" data-pltdoc="x">sustain</a></span><span class="hspace">&nbsp;</span><span class="RktSym">red</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:when</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">next-stage</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=begin.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._begin%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._await%29%29" class="RktStxLink" data-pltdoc="x">await</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">#:n</span><span class="hspace">&nbsp;</span><span class="RktVal">90</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">next-stage</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The Esterel form <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span> runs each of its
subexpressions (in this case, the <span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._abort%29%29" class="RktStxLink" data-pltdoc="x">abort</a></span> and the
<span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=begin.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._begin%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">begin</a></span>) in parallel to each other; it finishes only
after both of them finish. The <span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._abort%29%29" class="RktStxLink" data-pltdoc="x">abort</a></span> runs its first
argument (the call to <span class="RktSym"><a href="reference.html#%28def._%28%28lib._esterel%2Ffull..rkt%29._sustain%29%29" class="RktValLink" data-pltdoc="x">sustain</a></span>) until the code
following the <span class="RktPn">#:when</span> returns <span class="RktVal">#t</span>, at which
point it aborts it. That abort is the only way to terminate
the first branch of the <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span>. Meanwhile, the second
branch of the <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span> runs the <span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._await%29%29" class="RktStxLink" data-pltdoc="x">await</a></span>, which
waits until there have been <span class="RktVal">90</span> instants when
<span class="RktSym">second</span> is present. After that, the <span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._await%29%29" class="RktStxLink" data-pltdoc="x">await</a></span>
call returns and, in that same instant, the emit of
<span class="RktSym">next-stage</span> happens, ending the entire <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span>
expression.</p><p><div class="SIntrapara">Let&rsquo;s wrap all this up into a helper function:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">traffic-light-stage</span><span class="hspace">&nbsp;</span><span class="RktSym">color</span><span class="hspace">&nbsp;</span><span class="RktSym">seconds</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._with-signal%29%29" class="RktStxLink" data-pltdoc="x">with-signal</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">next-stage</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._abort%29%29" class="RktStxLink" data-pltdoc="x">abort</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28def._%28%28lib._esterel%2Ffull..rkt%29._sustain%29%29" class="RktValLink" data-pltdoc="x">sustain</a></span><span class="hspace">&nbsp;</span><span class="RktSym">color</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:when</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">next-stage</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=begin.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._begin%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="reference.html#%28form._%28%28lib._esterel%2Ffull..rkt%29._await%29%29" class="RktStxLink" data-pltdoc="x">await</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">#:n</span><span class="hspace">&nbsp;</span><span class="RktSym">seconds</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">next-stage</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote></div></p><p>and use <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._with-signal%29%29" class="RktStxLink" data-pltdoc="x">with-signal</a></span> to make a local signal,
<span class="RktSym">next-stage</span>, which is available only in the body of
the <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._with-signal%29%29" class="RktStxLink" data-pltdoc="x">with-signal</a></span>.</p><p><div class="SIntrapara">Now, we can write a reaction that repeatedly runs the traffic light:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">traffic-light-stage</span><span class="hspace">&nbsp;</span><span class="RktSym">green</span><span class="hspace">&nbsp;</span><span class="RktVal">90</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">traffic-light-stage</span><span class="hspace">&nbsp;</span><span class="RktSym">orange</span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">traffic-light-stage</span><span class="hspace">&nbsp;</span><span class="RktSym">red</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote></div></p><p><div class="SIntrapara">And if we use <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span>&rsquo;s <span class="RktPn">#:emit</span> keyword argument
to supply the <span class="RktSym">second</span> signal, we can see the light changing
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: green&gt; . #t) (#&lt;signal: second&gt; . #t))</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: green&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: next-stage (0)&gt; . #f))</span></p></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=for.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._for%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">for</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=sequences.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._in-range%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">in-range</a></span><span class="hspace">&nbsp;</span><span class="RktVal">87</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: green&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: next-stage (0)&gt; . #f))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: next-stage (0)&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: orange&gt; . #t))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: next-stage (1)&gt; . #f)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: orange&gt; . #t))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: next-stage (1)&gt; . #f)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: orange&gt; . #t))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: next-stage (1)&gt; . #f)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: orange&gt; . #t))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: red&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: next-stage (1)&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t))</span></p></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">three-stages</span><span class="hspace">&nbsp;</span><span class="RktPn">#:emit</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list%2529%2529&amp;version=8.11.1" class="RktValLink Sq" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym">second</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktRes">'#hash((#&lt;signal: red&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: second&gt; . #t)</span></p></td></tr><tr><td><p><span class="RktRes"></span><span class="hspace">&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktRes">(#&lt;signal: next-stage (2)&gt; . #f))</span></p></td></tr></table></td></tr></table></blockquote></div></p><p>For a more developed version of this example with some GUI
code to see the traffic light change color, see
<span class="stt">esterel/examples/traffic-light</span>.</p><h4 x-source-module="(lib &quot;esterel/esterel.scrbl&quot;)" x-source-pkg="esterel-doc" x-part-tag="&quot;Causality&quot;">1.2<tt>&nbsp;</tt><a name="(part._.Causality)"></a>Causality</h4><p>There is a subtle point about the semantics of Esterel and
how it manages to give the each instant its own consistent
world view. One way to understand it is to think that each
instant, instead of a totally ordered linear notion of time
it has, instead, a weaker notion of time, called causality.
That is, we do not know (or need to care) exactly which
events came before or after which other ones; instead we
need to know only which events cause other events: that is
enough to determine the flow of the computation.</p><p>In order to see how these aspects of Esterel computation
play out, let&rsquo;s start with a simple program. In this
program, because <span class="RktSym">S</span> is not set, the program takes
the else branch of the conditional and emits <span class="RktSym">O2</span>.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._define-signal%29%29" class="RktStxLink" data-pltdoc="x">define-signal</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="hspace">&nbsp;</span><span class="RktSym">O1</span><span class="hspace">&nbsp;</span><span class="RktSym">O2</span><span class="RktPn">)</span></td></tr><tr><td><p>&nbsp;</p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O1</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: S&gt; . #f) (#&lt;signal: O2&gt; . #t))</span></p></td></tr></table></blockquote><p>We can see the effect of <span class="RktSym">S</span> not being emitted and
<span class="RktSym">O2</span> being emitted in the result of <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span>,
as the hash maps <span class="RktSym">S</span> to <span class="RktVal">#f</span> and <span class="RktSym">O2</span>
to <span class="RktVal">#t</span>.</p><p><div class="SIntrapara">If we add a call to <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span> in sequence (i.e., before) the
conditional, as in this program, we causes the conditional
to take the other branch:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O1</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: O1&gt; . #t) (#&lt;signal: S&gt; . #t))</span></p></td></tr></table></blockquote></div></p><p>But Esterel does not require the emission to be sequentially
ordered with the <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> test. Since Esterel&rsquo;s
notion of parallelism is deterministic, this program is
guaranteed to behave as the previous one, always emitting
<span class="RktSym">O1</span> and never emitting <span class="RktSym">O2</span>, even though the
test for <span class="RktSym">S</span> is done in parallel to the emission of
<span class="RktSym">S</span>.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O1</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">O2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><p><span class="RktRes">'#hash((#&lt;signal: O1&gt; . #t) (#&lt;signal: S&gt; . #t))</span></p></td></tr></table></blockquote><p>To understand this, we must turn to the idea of causality.
That is, instead of a conventional understanding of the two
parallel branches of this <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span> as running at the
same time as each other, another way to think of them is
that there is no causality relationship between the two
evaluations and thus Esterel is free to run them however it
wants, subject to other causality dependencies being obeyed.
In other words, to Esterel, the difference between combining
two expression in parallel or sequentially is that combining
them sequentially forces a causality ordering on them, but
combining them in parallel does not.</p><p>Even though <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span> did not introduce a causal
dependency in this program, there still is a causality
dependency introduced. Specifically, each use of
<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span> introduces a causality dependency between it
and any uses of <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> (for the same signal). So,
in this program, <span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="stt"> </span><span class="RktSym">S</span><span class="RktPn">)</span> <span class="emph">causes</span>
the call <span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="stt"> </span><span class="RktSym">S</span><span class="RktPn">)</span> to return <span class="RktVal">#true</span> and
therefore therefore we can take only the branch that emits
<span class="RktSym">O1</span> and not the one that emits
<span class="RktSym">O2</span>.</p><p>This notion of causality determining the behavior of the
program also comes with the possibility of a new kind of
error, namely ones with causality problems. Such programs in
Esterel are called &ldquo;non constructive&rdquo; and <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span>
will raise an error when it encounters one. Here&rsquo;s an
example:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">non-causal</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="hspace">&nbsp;</span><span class="RktSym">S</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><p>&nbsp;</p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._react%21%29%29" class="RktValLink" data-pltdoc="x">react!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">non-causal</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">react!: the program is not constructive</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">the signal blocking progress can be emitted</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">signal: #&lt;signal: S&gt;</span></p></td></tr></table></blockquote><p>When looking at this program from a simple logical
perspective, we can see that it makes no sense for
<span class="RktSym">S</span> to be absent since that would cause the
<span class="RktSym"><a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.11.1" class="RktStxLink Sq" data-pltdoc="x">if</a></span> to take the else branch which would cause
<span class="RktSym">S</span> to be emitted.</p><p>But, from a causality perspective, it also makes no sense
for <span class="RktSym">S</span> to be present. There is nothing that happens
in the program before the call to <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> passing
<span class="RktSym">S</span> (and thus no emits happen). Thus, from a
causality perspective, since there is nothing that can cause
<span class="RktSym">S</span> to be present, <span class="RktSym">S</span> must be absent. In
order for this program to be error-free, the
<span class="RktPn">(</span><span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span><span class="stt"> </span><span class="RktSym">S</span><span class="RktPn">)</span> that happens in the then branch is
effectively causing information flow to go &ldquo;backwards&rdquo;,
against causation, as <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> cannot decide to
return <span class="RktVal">#t</span> without looking into the future beyond
the moment where it is invoked. Accordingly this program is
an error.</p><h4 x-source-module="(lib &quot;esterel/esterel.scrbl&quot;)" x-source-pkg="esterel-doc" x-part-tag="&quot;sec:conts&quot;">1.3<tt>&nbsp;</tt><a name="(part._sec~3aconts)"></a>Using Continuations to Replay
Reactions and How Mutation Causes Trouble</h4><p>This section tries to explain, at a high-level how Esterel
in Racket runs code in order to convey an intuition for how
using Racket-level mutable state goes wrong inside
<span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._esterel%29%29" class="RktStxLink" data-pltdoc="x">esterel</a></span>.</p><p>When a program runs within an <a href="#%28tech._instant%29" class="techoutside" data-pltdoc="x"><span class="techinside">instant</span></a>, it runs in two
modes: &ldquo;can mode&rdquo; and &ldquo;must mode&rdquo;.<span class="NoteBox"><span class="NoteContent">See
<span class="Autobibref"><a href="doc-bibliography.html#%28autobib._.G~c3~a9rard._.Berry.The._.Constructive._.Semantics._of._.Pure._.Esterel%2C._.Draft._.Version._32002http~3a%2F%2Fwww-sop..inria..fr%2Fmembers%2F.Gerard...Berry%2F.Papers%2F.Esterel.Constructive.Book..pdf%29" class="AutobibLink" data-pltdoc="x">Berry</a>&nbsp;(<a href="doc-bibliography.html#%28autobib._.G~c3~a9rard._.Berry.The._.Constructive._.Semantics._of._.Pure._.Esterel%2C._.Draft._.Version._32002http~3a%2F%2Fwww-sop..inria..fr%2Fmembers%2F.Gerard...Berry%2F.Papers%2F.Esterel.Constructive.Book..pdf%29" class="AutobibLink" data-pltdoc="x">2002</a>)</span>&rsquo;s <span style="font-style: italic">Constructive
Semantics of Esterel</span> for a fuller description of the Can
and Must functions that these modes mimic.</span></span> First, the
program runs in &ldquo;must mode&rdquo; where <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> does
not return <span class="RktVal">#f</span>, but instead blocks
(<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> might return <span class="RktVal">#t</span> if an
<span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._emit%29%29" class="RktValLink" data-pltdoc="x">emit</a></span> for the corresponding signal happens). In this
mode, the code is running very much like regular Racket code
runs; internally <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._par%29%29" class="RktStxLink" data-pltdoc="x">par</a></span> is creating racket-level
threads and <span class="RktSym"><a href="kernel.html#%28form._%28%28lib._esterel%2Fkernel..rkt%29._with-trap%29%29" class="RktStxLink" data-pltdoc="x">with-trap</a></span> creates an
<a href="https://download.racket-lang.org/releases/8.11.1/doc/local-redirect/index.html?doc=reference&amp;rel=eval-model.html%23%2528tech._escape._continuation%2529&amp;version=8.11.1" class="techoutside Sq" data-pltdoc="x"><span class="techinside">escape
continuation</span></a>.</p><p>At some point, however, all of the threads that are still
running get blocked on calls to <span class="RktSym"><a href="kernel.html#%28def._%28%28lib._esterel%2Fkernel..rkt%29._present~3f%29%29" class="RktValLink" data-pltdoc="x">present?</a></span> where the
corresponding signals have not yet been emitted. At this
point, the program enters &ldquo;can mode&rdquo;. It collects the set
of all of the continuations of all of the threads that are
blocked in this manner and then runs each of them forward
multiple times, once for each possible assignments of absent
and present to each of the signals that&rsquo;s being blocked on.
After this completes, either some of those signals were
never emitted during this process, or the program is
non-constructive. If there were some signals that were never
emitted, they are set to absent and we return to &ldquo;must
mode&rdquo;. If all of the blocking signals were emitted during at
least one of these runs, the program aborts with the
non-constructive error.</p><p>Accordingly, if one of the threads performs some mutation,
then that mutation is not rolled back by the continuations,
so it will happen possibly a large number of times and
certainly more than just once.</p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.11.1&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.11.1&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;Esterel in Racket&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Esterel in Racket&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="sec_eir-esterel.html" title="forward to &quot;2 Esterel in Racket, for Esterel Programmers&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>